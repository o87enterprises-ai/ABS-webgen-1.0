#!/bin/bash

# LLM Process Manager - Full Management Tool
# Manages: Local LLM API Server, MCP Monitor, Unified Dashboard, and HuggingFace Space

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Configuration
LOCAL_API_URL="http://localhost:8081"
DASHBOARD_URL="http://localhost:8080"
HF_SPACE_URL="https://truegleai-deepseek-coder-6b-api.hf.space"
LLM_API_SCRIPT="/Users/ducke.duck_1/mcp-monitoring-server/authenticated_llm_api.py"
MCP_MONITOR_DIR="/Users/ducke.duck_1/mcp-monitoring-server"
DASHBOARD_SCRIPT="/Users/ducke.duck_1/mcp-monitoring-server/unified_dashboard_server.py"
DASHBOARD_PID_FILE="/Users/ducke.duck_1/mcp-monitoring-server/pids/unified_server.pid"
DASHBOARD_LOG_FILE="/Users/ducke.duck_1/mcp-monitoring-server/logs/unified_server.log"

# Functions
check_process() {
    local script_name=$1
    ps aux | grep "$script_name" | grep -v grep | awk '{print $2}' | head -1
}

check_endpoint() {
    local url=$1
    curl -s -o /dev/null -w "%{http_code}" "$url" 2>/dev/null || echo "000"
}

status() {
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘         LLM Process Manager - Status Dashboard             â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""

    # Local LLM API
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo -e "${BLUE}1. Local LLM API Server${NC}"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

    local api_pid=$(check_process "authenticated_llm_api.py")
    if [ -n "$api_pid" ]; then
        echo -e "   Process Status: ${GREEN}âœ… RUNNING${NC} (PID: $api_pid)"
        local api_status=$(check_endpoint "$LOCAL_API_URL/api_key")
        if [ "$api_status" = "200" ]; then
            echo -e "   API Endpoint:   ${GREEN}âœ… ONLINE${NC} (HTTP $api_status)"
        else
            echo -e "   API Endpoint:   ${RED}âŒ OFFLINE${NC} (HTTP $api_status)"
        fi
    else
        echo -e "   Process Status: ${RED}âŒ NOT RUNNING${NC}"
        echo -e "   API Endpoint:   ${RED}âŒ OFFLINE${NC}"
    fi
    echo ""

    # MCP Monitor
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo -e "${BLUE}2. MCP Monitor${NC}"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

    local mcp_pid=$(check_process "llm_cli_integration.py")
    if [ -n "$mcp_pid" ]; then
        echo -e "   Process Status: ${GREEN}âœ… RUNNING${NC} (PID: $mcp_pid)"
    else
        echo -e "   Process Status: ${RED}âŒ NOT RUNNING${NC}"
    fi
    echo ""

    # Unified Dashboard
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo -e "${BLUE}3. Unified Dashboard Web GUI${NC}"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

    local dashboard_pid=$(check_process "unified_dashboard_server.py")
    if [ -n "$dashboard_pid" ]; then
        echo -e "   Process Status: ${GREEN}âœ… RUNNING${NC} (PID: $dashboard_pid)"
        local dashboard_status=$(check_endpoint "$DASHBOARD_URL")
        if [ "$dashboard_status" = "200" ] || [ "$dashboard_status" = "404" ]; then
            echo -e "   Web Interface:  ${GREEN}âœ… ONLINE${NC} at $DASHBOARD_URL"
        else
            echo -e "   Web Interface:  ${YELLOW}âš ï¸  STARTING${NC} (HTTP $dashboard_status)"
        fi
    else
        echo -e "   Process Status: ${RED}âŒ NOT RUNNING${NC}"
        echo -e "   Web Interface:  ${RED}âŒ OFFLINE${NC}"
    fi
    echo ""

    # HuggingFace Space
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo -e "${BLUE}4. HuggingFace Space API${NC}"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

    local hf_status=$(check_endpoint "$HF_SPACE_URL")
    if [ "$hf_status" = "200" ]; then
        echo -e "   API Status:     ${GREEN}âœ… ONLINE${NC} (HTTP $hf_status)"
    else
        echo -e "   API Status:     ${RED}âŒ OFFLINE${NC} (HTTP $hf_status)"
    fi
    echo "   Space URL:      $HF_SPACE_URL"
    echo ""
}

start_api() {
    local pid=$(check_process "authenticated_llm_api.py")
    if [ -n "$pid" ]; then
        echo -e "${YELLOW}âš ï¸  LLM API Server is already running (PID: $pid)${NC}"
    else
        echo -e "${BLUE}ğŸš€ Starting LLM API Server...${NC}"
        cd "$MCP_MONITOR_DIR"
        python3 authenticated_llm_api.py &
        sleep 2
        local new_pid=$(check_process "authenticated_llm_api.py")
        if [ -n "$new_pid" ]; then
            echo -e "${GREEN}âœ… LLM API Server started (PID: $new_pid)${NC}"
        else
            echo -e "${RED}âŒ Failed to start LLM API Server${NC}"
        fi
    fi
}

start_mcp() {
    local pid=$(check_process "llm_cli_integration.py")
    if [ -n "$pid" ]; then
        echo -e "${YELLOW}âš ï¸  MCP Monitor is already running (PID: $pid)${NC}"
    else
        echo -e "${BLUE}ğŸš€ Starting MCP Monitor...${NC}"
        llm-launch &
        sleep 2
        local new_pid=$(check_process "llm_cli_integration.py")
        if [ -n "$new_pid" ]; then
            echo -e "${GREEN}âœ… MCP Monitor started (PID: $new_pid)${NC}"
        else
            echo -e "${RED}âŒ Failed to start MCP Monitor${NC}"
        fi
    fi
}

stop_api() {
    local pid=$(check_process "authenticated_llm_api.py")
    if [ -z "$pid" ]; then
        echo -e "${YELLOW}âš ï¸  LLM API Server is not running${NC}"
    else
        echo -e "${BLUE}ğŸ›‘ Stopping LLM API Server (PID: $pid)...${NC}"
        kill $pid
        sleep 1
        local check_pid=$(check_process "authenticated_llm_api.py")
        if [ -z "$check_pid" ]; then
            echo -e "${GREEN}âœ… LLM API Server stopped${NC}"
        else
            echo -e "${RED}âŒ Failed to stop cleanly, forcing...${NC}"
            kill -9 $pid
        fi
    fi
}

stop_mcp() {
    local pid=$(check_process "llm_cli_integration.py")
    if [ -z "$pid" ]; then
        echo -e "${YELLOW}âš ï¸  MCP Monitor is not running${NC}"
    else
        echo -e "${BLUE}ğŸ›‘ Stopping MCP Monitor (PID: $pid)...${NC}"
        kill $pid
        sleep 1
        local check_pid=$(check_process "llm_cli_integration.py")
        if [ -z "$check_pid" ]; then
            echo -e "${GREEN}âœ… MCP Monitor stopped${NC}"
        else
            echo -e "${RED}âŒ Failed to stop cleanly, forcing...${NC}"
            kill -9 $pid
        fi
    fi
}

start_dashboard() {
    local pid=$(check_process "unified_dashboard_server.py")
    if [ -n "$pid" ]; then
        echo -e "${YELLOW}âš ï¸  Unified Dashboard is already running (PID: $pid)${NC}"
    else
        echo -e "${BLUE}ğŸš€ Starting Unified Dashboard Web GUI...${NC}"

        # Create directories if they don't exist
        mkdir -p "$(dirname "$DASHBOARD_PID_FILE")"
        mkdir -p "$(dirname "$DASHBOARD_LOG_FILE")"

        cd "$MCP_MONITOR_DIR"
        nohup python3 "$DASHBOARD_SCRIPT" > "$DASHBOARD_LOG_FILE" 2>&1 &
        echo $! > "$DASHBOARD_PID_FILE"
        sleep 3

        local new_pid=$(check_process "unified_dashboard_server.py")
        if [ -n "$new_pid" ]; then
            echo -e "${GREEN}âœ… Unified Dashboard started (PID: $new_pid)${NC}"
            echo -e "${GREEN}   Access at: $DASHBOARD_URL${NC}"
        else
            echo -e "${RED}âŒ Failed to start Unified Dashboard${NC}"
            if [ -f "$DASHBOARD_LOG_FILE" ]; then
                echo -e "${RED}   Last log entries:${NC}"
                tail -5 "$DASHBOARD_LOG_FILE"
            fi
        fi
    fi
}

stop_dashboard() {
    local pid=$(check_process "unified_dashboard_server.py")
    if [ -z "$pid" ]; then
        echo -e "${YELLOW}âš ï¸  Unified Dashboard is not running${NC}"
    else
        echo -e "${BLUE}ğŸ›‘ Stopping Unified Dashboard (PID: $pid)...${NC}"
        kill $pid
        sleep 1
        local check_pid=$(check_process "unified_dashboard_server.py")
        if [ -z "$check_pid" ]; then
            echo -e "${GREEN}âœ… Unified Dashboard stopped${NC}"
            [ -f "$DASHBOARD_PID_FILE" ] && rm "$DASHBOARD_PID_FILE"
        else
            echo -e "${RED}âŒ Failed to stop cleanly, forcing...${NC}"
            kill -9 $pid
            [ -f "$DASHBOARD_PID_FILE" ] && rm "$DASHBOARD_PID_FILE"
        fi
    fi
}

start_all() {
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘              Starting All LLM Services                     â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    start_api
    echo ""
    start_mcp
    echo ""
    start_dashboard
    echo ""
    echo -e "${GREEN}âœ… All services started${NC}"
    echo ""
    echo "Access points:"
    echo "  â€¢ LLM API: $LOCAL_API_URL"
    echo "  â€¢ Dashboard: $DASHBOARD_URL"
}

stop_all() {
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘              Stopping All LLM Services                     â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    stop_dashboard
    echo ""
    stop_mcp
    echo ""
    stop_api
    echo ""
    echo -e "${GREEN}âœ… All services stopped${NC}"
}

restart_all() {
    stop_all
    echo ""
    sleep 2
    start_all
}

show_help() {
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘              LLM Process Manager - Help                    â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    echo "Usage: llm-manager [command]"
    echo ""
    echo "Commands:"
    echo "  status              Show status of all services (default)"
    echo "  start               Start all services"
    echo "  stop                Stop all services"
    echo "  restart             Restart all services"
    echo "  start-api           Start only LLM API server"
    echo "  start-mcp           Start only MCP monitor"
    echo "  start-dashboard     Start only Unified Dashboard Web GUI"
    echo "  stop-api            Stop only LLM API server"
    echo "  stop-mcp            Stop only MCP monitor"
    echo "  stop-dashboard      Stop only Unified Dashboard Web GUI"
    echo "  help                Show this help message"
    echo ""
    echo "Service URLs:"
    echo "  â€¢ LLM API:       $LOCAL_API_URL"
    echo "  â€¢ Dashboard:     $DASHBOARD_URL"
    echo "  â€¢ HF Space:      $HF_SPACE_URL"
    echo ""
    echo "Examples:"
    echo "  llm-manager                  # Show status"
    echo "  llm-manager start            # Start all services"
    echo "  llm-manager restart          # Restart everything"
    echo "  llm-manager start-dashboard  # Start only the web dashboard"
    echo ""
}

# Main command handling
case "${1:-status}" in
    status)
        status
        ;;
    start)
        start_all
        ;;
    stop)
        stop_all
        ;;
    restart)
        restart_all
        ;;
    start-api)
        start_api
        ;;
    start-mcp)
        start_mcp
        ;;
    start-dashboard)
        start_dashboard
        ;;
    stop-api)
        stop_api
        ;;
    stop-mcp)
        stop_mcp
        ;;
    stop-dashboard)
        stop_dashboard
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}Unknown command: $1${NC}"
        echo ""
        show_help
        exit 1
        ;;
esac
